name: Android CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  build-xray-android:
    name: Build Xray for Android
    runs-on: ubuntu-latest
    strategy:
      matrix:
        arch: [arm64-v8a, armeabi-v7a, x86, x86_64]
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive
        fetch-depth: 0

    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.21'
        cache-dependency-path: xray-core/go.sum

    - name: Set up Android NDK
      uses: nttld/setup-ndk@v1.4.2
      id: setup-ndk
      with:
        ndk-version: r25c

    - name: Build Xray for Android
      working-directory: xray-core
      env:
        ANDROID_NDK_HOME: ${{ steps.setup-ndk.outputs.ndk-path }}
      run: |
        # Set architecture-specific environment variables
        case "${{ matrix.arch }}" in
          "arm64-v8a")
            export GOOS=android
            export GOARCH=arm64
            export CC=$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android21-clang
            ;;
          "armeabi-v7a")
            export GOOS=android
            export GOARCH=arm
            export GOARM=7
            export CC=$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/armv7a-linux-androideabi21-clang
            ;;
          "x86")
            export GOOS=android
            export GOARCH=386
            export CC=$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/i686-linux-android21-clang
            ;;
          "x86_64")
            export GOOS=android
            export GOARCH=amd64
            export CC=$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/x86_64-linux-android21-clang
            ;;
        esac
        
        export CGO_ENABLED=1
        export CGO_CFLAGS="-O2 -Werror"
        
        # Build Xray
        go build -v -o xray-${{ matrix.arch }} -trimpath -ldflags "-s -w -buildid=" ./main

    - name: Upload Xray binary
      uses: actions/upload-artifact@v4
      with:
        name: xray-android-${{ matrix.arch }}
        path: xray-core/xray-${{ matrix.arch }}
        retention-days: 1

  build-android-apk:
    name: Build Android APK
    runs-on: ubuntu-latest
    needs: build-xray-android
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Setup Android SDK
      uses: android-actions/setup-android@v3

    - name: Validate Gradle wrapper
      uses: gradle/wrapper-validation-action@v2

    - name: Cache Gradle packages
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-

    - name: Download Xray binaries
      uses: actions/download-artifact@v4
      with:
        path: xray-binaries

    - name: Prepare Xray binaries for Android
      run: |
        mkdir -p android/app/src/main/jniLibs/arm64-v8a
        mkdir -p android/app/src/main/jniLibs/armeabi-v7a
        mkdir -p android/app/src/main/jniLibs/x86
        mkdir -p android/app/src/main/jniLibs/x86_64
        
        # Copy and rename binaries
        cp xray-binaries/xray-android-arm64-v8a/xray-arm64-v8a android/app/src/main/jniLibs/arm64-v8a/libxray.so
        cp xray-binaries/xray-android-armeabi-v7a/xray-armeabi-v7a android/app/src/main/jniLibs/armeabi-v7a/libxray.so
        cp xray-binaries/xray-android-x86/xray-x86 android/app/src/main/jniLibs/x86/libxray.so
        cp xray-binaries/xray-android-x86_64/xray-x86_64 android/app/src/main/jniLibs/x86_64/libxray.so
        
        # Make binaries executable
        chmod +x android/app/src/main/jniLibs/*/libxray.so

    - name: Create keystore for signing
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      run: |
        echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 -d > android/app/keystore.jks
      env:
        ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}

    - name: Setup Gradle Wrapper
      working-directory: android
      run: |
        # Ensure gradle wrapper jar exists
        if [ ! -f "gradle/wrapper/gradle-wrapper.jar" ]; then
          echo "Downloading Gradle Wrapper JAR..."
          mkdir -p gradle/wrapper
          curl -L -o gradle/wrapper/gradle-wrapper.jar \
            "https://github.com/gradle/gradle/raw/v8.4.0/gradle/wrapper/gradle-wrapper.jar"
        fi
        
        # Ensure gradlew scripts exist and are correct
        if [ ! -f "gradlew" ] || [ ! -s "gradlew" ]; then
          echo "Downloading gradlew script..."
          curl -L -o gradlew "https://github.com/gradle/gradle/raw/v8.4.0/gradlew"
        fi
        
        if [ ! -f "gradlew.bat" ] || [ ! -s "gradlew.bat" ]; then
          echo "Downloading gradlew.bat script..."
          curl -L -o gradlew.bat "https://github.com/gradle/gradle/raw/v8.4.0/gradlew.bat"
        fi
        
        # Make gradlew executable
        chmod +x gradlew
        
        # Test wrapper
        ./gradlew --version

    - name: Build Debug APK
      if: github.event_name == 'pull_request'
      working-directory: android
      run: ./gradlew assembleDebug

    - name: Build Release APK
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      working-directory: android
      env:
        KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
        KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
        KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
      run: |
        ./gradlew assembleRelease \
          -Pandroid.injected.signing.store.file=app/keystore.jks \
          -Pandroid.injected.signing.store.password=$KEYSTORE_PASSWORD \
          -Pandroid.injected.signing.key.alias=$KEY_ALIAS \
          -Pandroid.injected.signing.key.password=$KEY_PASSWORD

    - name: Upload Debug APK
      if: github.event_name == 'pull_request'
      uses: actions/upload-artifact@v4
      with:
        name: neotun-debug.apk
        path: android/app/build/outputs/apk/debug/app-debug.apk

    - name: Upload Release APK
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      uses: actions/upload-artifact@v4
      with:
        name: neotun-release.apk
        path: android/app/build/outputs/apk/release/app-release.apk

    - name: Clean up keystore
      if: always()
      run: rm -f android/app/keystore.jks