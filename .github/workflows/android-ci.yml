name: Android CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  GRADLE_OPTS: -Dorg.gradle.daemon=false -Dorg.gradle.workers.max=2
  GRADLE_USER_HOME: ${{ github.workspace }}/.gradle

jobs:
  build-xray-android:
    name: Build Xray for Android
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        arch: [arm64-v8a, armeabi-v7a, x86, x86_64]
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive
        fetch-depth: 0

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.21'
        cache-dependency-path: xray-core/go.sum

    - name: Set up Android NDK
      uses: nttld/setup-ndk@v1.4.2
      id: setup-ndk
      with:
        ndk-version: r25c

    - name: Build Xray for Android
      working-directory: xray-core
      env:
        ANDROID_NDK_HOME: ${{ steps.setup-ndk.outputs.ndk-path }}
      run: |
        case "${{ matrix.arch }}" in
          "arm64-v8a")
            export GOOS=android GOARCH=arm64
            export CC=$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android21-clang
            ;;
          "armeabi-v7a")
            export GOOS=android GOARCH=arm GOARM=7
            export CC=$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/armv7a-linux-androideabi21-clang
            ;;
          "x86")
            export GOOS=android GOARCH=386
            export CC=$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/i686-linux-android21-clang
            ;;
          "x86_64")
            export GOOS=android GOARCH=amd64
            export CC=$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/x86_64-linux-android21-clang
            ;;
        esac
        
        export CGO_ENABLED=1 CGO_CFLAGS="-O2 -Werror"
        VERSION_LDFLAGS="-X github.com/xtls/xray-core/core.version=$(git describe --tags --always --dirty)"
        
        go build -v -o xray-${{ matrix.arch }} -trimpath -ldflags "-s -w -buildid= $VERSION_LDFLAGS" ./main

    - name: Upload Xray binary
      uses: actions/upload-artifact@v4
      with:
        name: xray-android-${{ matrix.arch }}
        path: xray-core/xray-${{ matrix.arch }}
        retention-days: 1

  build-android-apk:
    name: Build Android APK
    runs-on: ubuntu-latest
    needs: build-xray-android
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Setup Android SDK
      uses: android-actions/setup-android@v3

    - name: Cache Gradle packages
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
          ${{ github.workspace }}/.gradle
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: ${{ runner.os }}-gradle-

    - name: Download Xray binaries
      uses: actions/download-artifact@v4
      with:
        path: xray-binaries

    - name: Prepare Xray binaries
      run: |
        mkdir -p android/app/src/main/jniLibs/{arm64-v8a,armeabi-v7a,x86,x86_64}
        cp xray-binaries/xray-android-arm64-v8a/xray-arm64-v8a android/app/src/main/jniLibs/arm64-v8a/libxray.so
        cp xray-binaries/xray-android-armeabi-v7a/xray-armeabi-v7a android/app/src/main/jniLibs/armeabi-v7a/libxray.so
        cp xray-binaries/xray-android-x86/xray-x86 android/app/src/main/jniLibs/x86/libxray.so
        cp xray-binaries/xray-android-x86_64/xray-x86_64 android/app/src/main/jniLibs/x86_64/libxray.so
        chmod +x android/app/src/main/jniLibs/*/libxray.so

    - name: Setup Gradle Wrapper
      working-directory: android
      run: |
        if [ ! -f "gradle/wrapper/gradle-wrapper.jar" ]; then
          mkdir -p gradle/wrapper
          curl -L -o gradle/wrapper/gradle-wrapper.jar "https://github.com/gradle/gradle/raw/v8.4.0/gradle/wrapper/gradle-wrapper.jar"
        fi
        chmod +x gradlew

    - name: Build APK
      working-directory: android
      run: |
        if [ "${{ github.event_name }}" = "pull_request" ]; then
          ./gradlew assembleDebug --stacktrace
        else
          ./gradlew assembleRelease --stacktrace
        fi

    - name: Upload Debug APK
      if: github.event_name == 'pull_request'
      uses: actions/upload-artifact@v4
      with:
        name: neotun-debug-apk
        path: android/app/build/outputs/apk/debug/app-debug.apk

    - name: Upload Release APK
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      uses: actions/upload-artifact@v4
      with:
        name: neotun-release-apk
        path: android/app/build/outputs/apk/release/app-release.apk