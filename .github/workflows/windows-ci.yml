name: Windows CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  build-xray-windows:
    name: Build Xray for Windows
    runs-on: windows-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive
        fetch-depth: 0

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.21'
        cache-dependency-path: xray-core/go.sum

    - name: Build Xray for Windows
      working-directory: xray-core
      env:
        GOOS: windows
        GOARCH: amd64
        CGO_ENABLED: 0
      run: |
        $VERSION_LDFLAGS = "-X github.com/xtls/xray-core/core.version=$(git describe --tags --always --dirty)"
        go build -v -o xray.exe -trimpath -ldflags "-s -w -buildid= $VERSION_LDFLAGS" ./main

    - name: Upload Xray binary
      uses: actions/upload-artifact@v4
      with:
        name: xray-windows
        path: xray-core/xray.exe
        retention-days: 1

  build-windows-app:
    name: Build Windows Application
    runs-on: windows-latest
    needs: build-xray-windows
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup .NET 8
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'

    - name: Download Xray binary
      uses: actions/download-artifact@v4
      with:
        name: xray-windows
        path: xray-binary

    - name: Download Wintun driver
      run: |
        $wintunUrl = "https://www.wintun.net/builds/wintun-0.14.1.zip"
        Invoke-WebRequest -Uri $wintunUrl -OutFile "wintun.zip"
        Expand-Archive -Path "wintun.zip" -DestinationPath "wintun"
        Copy-Item "wintun/wintun/bin/amd64/wintun.dll" "windows/NeoTUN.Windows/wintun.dll"

    - name: Copy dependencies to Windows project
      run: |
        Copy-Item "xray-binary/xray.exe" "windows/NeoTUN.Windows/xray.exe"

    - name: Restore dependencies
      working-directory: windows
      run: dotnet restore

    - name: Build application
      working-directory: windows
      run: dotnet build --configuration Release --no-restore

    - name: Publish self-contained executable
      working-directory: windows
      run: |
        dotnet publish NeoTUN.Windows/NeoTUN.Windows.csproj `
          --configuration Release `
          --runtime win-x64 `
          --self-contained true `
          --output ../publish `
          -p:PublishSingleFile=true `
          -p:IncludeNativeLibrariesForSelfExtract=true `
          -p:PublishTrimmed=false

    - name: Upload Windows executable
      uses: actions/upload-artifact@v4
      with:
        name: neotun-windows-exe
        path: publish/NeoTUN.Windows.exe
        retention-days: 30

  build-msix-package:
    name: Build MSIX Package
    runs-on: windows-latest
    needs: build-windows-app
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup .NET 8
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'

    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v2

    - name: Download Windows executable
      uses: actions/download-artifact@v4
      with:
        name: neotun-windows-exe
        path: windows-exe

    - name: Generate MSIX assets
      run: |
        # Create Images directory
        New-Item -ItemType Directory -Force -Path "windows/NeoTUN.Package/Images"
        
        # Create minimal PNG files (transparent pixels)
        $pngBytes = [System.Convert]::FromBase64String("iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg==")
        
        # Generate required MSIX assets
        [System.IO.File]::WriteAllBytes("windows/NeoTUN.Package/Images/Square44x44Logo.scale-200.png", $pngBytes)
        [System.IO.File]::WriteAllBytes("windows/NeoTUN.Package/Images/Square150x150Logo.scale-200.png", $pngBytes)
        [System.IO.File]::WriteAllBytes("windows/NeoTUN.Package/Images/Wide310x150Logo.scale-200.png", $pngBytes)
        [System.IO.File]::WriteAllBytes("windows/NeoTUN.Package/Images/SplashScreen.scale-200.png", $pngBytes)
        [System.IO.File]::WriteAllBytes("windows/NeoTUN.Package/Images/StoreLogo.png", $pngBytes)
        [System.IO.File]::WriteAllBytes("windows/NeoTUN.Package/Images/LockScreenLogo.scale-200.png", $pngBytes)
        [System.IO.File]::WriteAllBytes("windows/NeoTUN.Package/Images/Square44x44Logo.targetsize-24_altform-unplated.png", $pngBytes)

    - name: Build MSIX package
      working-directory: windows
      run: |
        # Build the packaging project
        msbuild NeoTUN.Package/NeoTUN.Package.wapproj `
          /p:Configuration=Release `
          /p:Platform=x64 `
          /p:AppxBundlePlatforms=x64 `
          /p:AppxPackageDir="../msix-output/" `
          /p:UapAppxPackageBuildMode=StoreUpload

    - name: Sign MSIX package
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      env:
        WINDOWS_CERTIFICATE_BASE64: ${{ secrets.WINDOWS_CERTIFICATE_BASE64 }}
        WINDOWS_CERTIFICATE_PASSWORD: ${{ secrets.WINDOWS_CERTIFICATE_PASSWORD }}
      run: |
        if (-not [string]::IsNullOrEmpty($env:WINDOWS_CERTIFICATE_BASE64)) {
          # Create certificate from base64 secret
          $certBytes = [System.Convert]::FromBase64String($env:WINDOWS_CERTIFICATE_BASE64)
          [System.IO.File]::WriteAllBytes("cert.pfx", $certBytes)
          
          # Find and sign the MSIX package
          $msixFile = Get-ChildItem -Path "msix-output" -Filter "*.msix" -Recurse | Select-Object -First 1
          if ($msixFile) {
            $signtool = "${env:ProgramFiles(x86)}\Windows Kits\10\bin\10.0.22621.0\x64\signtool.exe"
            if (-not (Test-Path $signtool)) {
              $signtool = "${env:ProgramFiles(x86)}\Windows Kits\10\bin\10.0.19041.0\x64\signtool.exe"
            }
            
            if (Test-Path $signtool) {
              & $signtool sign /fd SHA256 /f "cert.pfx" /p $env:WINDOWS_CERTIFICATE_PASSWORD $msixFile.FullName
            }
          }
          
          Remove-Item "cert.pfx" -ErrorAction SilentlyContinue
        }

    - name: Upload MSIX package
      uses: actions/upload-artifact@v4
      with:
        name: neotun-windows-msix
        path: msix-output/*.msix
        retention-days: 30